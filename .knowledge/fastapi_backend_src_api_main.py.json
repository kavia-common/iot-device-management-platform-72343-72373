{"is_source_file": true, "format": "Python", "description": "Main source file for the IoT device management platform backend using FastAPI, including endpoints for device management, telemetry ingestion, thresholds, alerts, user authentication with JWT, webhook handling for payments, MQTT integration, and Firestore database interactions.", "external_files": ["fastapi", "fastapi.middleware.cors", "fastapi.security", "fastapi.responses", "pydantic", "jwt", "paho.mqtt.client", "stripe", "razorpay", "firebase_admin", "dotenv"], "external_methods": ["jwt.encode", "jwt.decode", "stripe_sdk.checkout.Session.create", "firebase_admin.initialize_app", "firebase_admin.credentials.Certificate", "firestore.client", "smtplib.SMTP", "smtplib.SMTP.starttls", "smtplib.SMTP.login", "smtplib.SMTP.sendmail", "hmac.new", "hashlib.sha256"], "published": ["create_jwt", "decode_jwt", "get_current_user", "load_dotenv", "app"], "classes": [{"name": "AuthRequest", "description": "Pydantic model for authentication request containing user email and ID."}, {"name": "AuthResponse", "description": "Response model containing generated JWT token and user plan."}, {"name": "DeviceCreate", "description": "Model for creating a new device with name, optional description, and metadata."}, {"name": "DeviceUpdate", "description": "Model for updating device details."}, {"name": "DeviceOut", "description": "Response model for device details including ID, owner, timestamps."}, {"name": "Threshold", "description": "Model defining threshold rules for device metrics."}, {"name": "TelemetryIngest", "description": "Model for ingesting telemetry data from devices."}, {"name": "UsageQuery", "description": "Model for querying usage data with optional time range and rollup."}, {"name": "UsagePoint", "description": "Timestamped set of device metrics, used for returning usage data."}, {"name": "AlertOut", "description": "Structured alert data sent in responses, includes message, timestamp, rule type."}, {"name": "PlanUpdate", "description": "Model for updating user plan (free or premium)."}, {"name": "CheckoutSessionRequest", "description": "Request model for initiating checkout with provider and optional price ID."}], "methods": [{"name": "on_startup", "description": "Initializes Firestore and starts MQTT client when app launches."}, {"name": "health_check()", "description": "Health check endpoint to verify service is operational.", "scope": "", "scopeKind": ""}, {"name": "login(auth: AuthRequest)", "description": "Generates a JWT token for login, accepting any provided email/user id for demo.", "scope": "", "scopeKind": ""}, {"name": "set_plan", "description": "Admin/demo endpoint to set or change user plan."}, {"name": "create_device(payload: DeviceCreate, user=Depends(get_current_user))", "description": "Creates a new device for the authenticated user.", "scope": "", "scopeKind": ""}, {"name": "list_devices(user=Depends(get_current_user))", "description": "Retrieves all devices owned by the current user.", "scope": "", "scopeKind": ""}, {"name": "get_device(device_id: str, user=Depends(get_current_user))", "description": "Fetches details for a specific device by ID, validating ownership.", "scope": "", "scopeKind": ""}, {"name": "update_device", "description": "Updates details of an existing device."}, {"name": "delete_device(device_id: str, user=Depends(get_current_user))", "description": "Deletes a specified device.", "scope": "", "scopeKind": ""}, {"name": "ingest_http(payload: TelemetryIngest, user=Depends(get_current_user))", "description": "Endpoint for ingesting telemetry data via HTTP POST, alternative to MQTT.", "scope": "", "scopeKind": ""}, {"name": "usage", "description": "Returns raw or rollup usage data for a device over a specified period."}, {"name": "add_threshold(t: Threshold, user=Depends(get_current_user))", "description": "Creates a threshold rule for a device metric.", "scope": "", "scopeKind": ""}, {"name": "list_thresholds(user=Depends(get_current_user))", "description": "Lists all thresholds for the user's devices.", "scope": "", "scopeKind": ""}, {"name": "update_threshold", "description": "Modifies an existing threshold rule."}, {"name": "delete_threshold(threshold_id: str, user=Depends(get_current_user))", "description": "Deletes a threshold rule.", "scope": "", "scopeKind": ""}, {"name": "get_alerts(device_id: str, user=Depends(get_current_user))", "description": "Retrieves alerts for a specific device.", "scope": "", "scopeKind": ""}, {"name": "payments_checkout", "description": "Creates a checkout session for Stripe or Razorpay."}, {"name": "stripe_webhook", "description": "Handles Stripe webhook events, promotes user to premium upon success."}, {"name": "razorpay_webhook", "description": "Handles Razorpay webhook events for successful payments."}, {"name": "mqtt_docs", "description": "Provides documentation for setting up MQTT telemetry ingestion."}, {"name": "_check_thresholds_and_anomaly(db, device_id: str, metric: str, value: float, ts: datetime)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "Dict[str,Any] _create_stripe_session(price_id: str, user_id: str)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "_enforce_plan_limits(db, user_id: str)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "Optional[str] _get_device_owner(db, device_id: str)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "List[UsagePoint] _get_usage(db, device_id: str, metric: Optional[str], start: Optional[datetime], end: Optional[datetime], rollup: Optional[str])", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "_handle_telemetry_message(db, payload: dict)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "Optional[Any] _init_firestore_if_needed()", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "_mqtt_on_connect(client, userdata, flags, rc)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "_mqtt_on_message(client, userdata, msg)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "_notify_if_premium(db, device_owner_id: str, subject: str, body: str)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "List[UsagePoint] _rollup_range(db, device_id: str, metric: Optional[str], start: datetime, end: datetime, granularity: str)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "None _send_email(to_email: str, subject: str, body: str)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "_set_user_plan(db, user_id: str, plan: str)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "_start_mqtt()", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "_store_alert(db, alert: Dict[str, Any])", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "str _user_plan(db, user_id: str)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "bool _verify_razorpay_signature(payload_body: bytes, signature: str, secret: str)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "str create_jwt(user_id: str, email: Optional[str] = None, plan: str = \"free\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "dict decode_jwt(token: str)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "datetime floor_day(dt: datetime)", "scope": "_rollup_range", "scopeKind": "function", "description": "unavailable"}, {"name": "datetime floor_hour(dt: datetime)", "scope": "_rollup_range", "scopeKind": "function", "description": "unavailable"}, {"name": "dict get_current_user(credentials: Optional[HTTPAuthorizationCredentials] = Depends(bearer_scheme))", "scope": "", "scopeKind": "", "description": "unavailable"}], "calls": ["jwt.encode", "jwt.decode", "stripe_sdk.checkout.Session.create", "firebase_admin.initialize_app", "firestore.client", "smtplib.SMTP", "hmac.new", "hashlib.sha256", "stripe_sdk.Webhook.construct_event"], "search-terms": ["FastAPI", "JWT", "firestore", "MQTT", "Thresholds", "Alerts", "Telemetry", "Device management", "Razorpay webhook", "Stripe webhook", "Payment processing", "Device thresholds", "OAuth", "Authentication"], "state": 2, "file_id": 2, "knowledge_revision": 16, "git_revision": "e934f1f69c13abae9a6f8afd2e0e67d3aad8cc9d", "revision_history": [{"9": "e7886ba6dcaa3c6706473061a0770d7610f33ec2"}, {"10": "e7886ba6dcaa3c6706473061a0770d7610f33ec2"}, {"14": "e7886ba6dcaa3c6706473061a0770d7610f33ec2"}, {"15": "e934f1f69c13abae9a6f8afd2e0e67d3aad8cc9d"}, {"16": "e934f1f69c13abae9a6f8afd2e0e67d3aad8cc9d"}], "ctags": [{"_type": "tag", "name": "AlertOut", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^class AlertOut(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "AuthRequest", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^class AuthRequest(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "AuthResponse", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^class AuthResponse(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "COL_ALERTS", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^COL_ALERTS = \"alerts\"$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "COL_DEVICES", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^COL_DEVICES = \"devices\"$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "COL_PAYMENTS", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^COL_PAYMENTS = \"payments\"$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "COL_ROLLUPS", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^COL_ROLLUPS = \"rollups\"$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "COL_TELEMETRY", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^COL_TELEMETRY = \"telemetry\"$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "COL_THRESHOLDS", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^COL_THRESHOLDS = \"thresholds\"$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "COL_USER_PLANS", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^COL_USER_PLANS = \"user_plans\"$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "CheckoutSessionRequest", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^class CheckoutSessionRequest(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "DeviceCreate", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^class DeviceCreate(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "DeviceOut", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^class DeviceOut(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "DeviceUpdate", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^class DeviceUpdate(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "EMAIL_FROM", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^EMAIL_FROM = os.getenv(\"EMAIL_FROM\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "FIREBASE_CRED_BASE64", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^FIREBASE_CRED_BASE64 = os.getenv(\"FIREBASE_CRED_BASE64\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "FIREBASE_CRED_JSON", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^FIREBASE_CRED_JSON = os.getenv(\"FIREBASE_CRED_JSON\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "JWT_ALG", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^JWT_ALG = os.getenv(\"JWT_ALG\", \"HS256\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "JWT_EXP_MIN", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^JWT_EXP_MIN = int(os.getenv(\"JWT_EXP_MIN\", \"60\"))$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "JWT_SECRET", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^JWT_SECRET = os.getenv(\"JWT_SECRET\", \"dev-secret-change-me\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "MQTT_BROKER_HOST", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^MQTT_BROKER_HOST = os.getenv(\"MQTT_BROKER_HOST\", \"broker.hivemq.com\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "MQTT_BROKER_PORT", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^MQTT_BROKER_PORT = int(os.getenv(\"MQTT_BROKER_PORT\", \"1883\"))$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "MQTT_PASSWORD", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^MQTT_PASSWORD = os.getenv(\"MQTT_PASSWORD\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "MQTT_TOPIC", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^MQTT_TOPIC = os.getenv(\"MQTT_TOPIC\", \"iot\\/demo\\/telemetry\\/#\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "MQTT_USERNAME", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^MQTT_USERNAME = os.getenv(\"MQTT_USERNAME\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "PLAN_FREE_EMAIL_NOTIF", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^PLAN_FREE_EMAIL_NOTIF = os.getenv(\"PLAN_FREE_EMAIL_NOTIF\", \"false\").lower() == \"true\"$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "PLAN_FREE_MAX_DEVICES", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^PLAN_FREE_MAX_DEVICES = int(os.getenv(\"PLAN_FREE_MAX_DEVICES\", \"2\"))$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "PlanUpdate", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^class PlanUpdate(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "RAZORPAY_KEY_ID", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^RAZORPAY_KEY_ID = os.getenv(\"RAZORPAY_KEY_ID\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "RAZORPAY_KEY_SECRET", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^RAZORPAY_KEY_SECRET = os.getenv(\"RAZORPAY_KEY_SECRET\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "ROLLUP_CRON_DISABLED", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^ROLLUP_CRON_DISABLED = os.getenv(\"ROLLUP_CRON_DISABLED\", \"false\").lower() == \"true\"$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "SITE_URL", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^SITE_URL = os.getenv(\"SITE_URL\", \"http:\\/\\/localhost:8000\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "SMTP_HOST", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^SMTP_HOST = os.getenv(\"SMTP_HOST\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "SMTP_PASS", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^SMTP_PASS = os.getenv(\"SMTP_PASS\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "SMTP_PORT", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^SMTP_PORT = int(os.getenv(\"SMTP_PORT\", \"587\")) if os.getenv(\"SMTP_PORT\") else None$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "SMTP_USER", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^SMTP_USER = os.getenv(\"SMTP_USER\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "STRIPE_API_KEY", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^STRIPE_API_KEY = os.getenv(\"STRIPE_API_KEY\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "STRIPE_WEBHOOK_SECRET", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^STRIPE_WEBHOOK_SECRET = os.getenv(\"STRIPE_WEBHOOK_SECRET\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "TelemetryIngest", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^class TelemetryIngest(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "Threshold", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^class Threshold(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "UsagePoint", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^class UsagePoint(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "UsageQuery", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^class UsageQuery(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "_check_thresholds_and_anomaly", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def _check_thresholds_and_anomaly(db, device_id: str, metric: str, value: float, ts: datetime):$/", "language": "Python", "kind": "function", "signature": "(db, device_id: str, metric: str, value: float, ts: datetime)"}, {"_type": "tag", "name": "_create_stripe_session", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def _create_stripe_session(price_id: str, user_id: str) -> Dict[str, Any]:$/", "language": "Python", "typeref": "typename:Dict[str,Any]", "kind": "function", "signature": "(price_id: str, user_id: str)"}, {"_type": "tag", "name": "_db", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^_db = None$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "_enforce_plan_limits", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def _enforce_plan_limits(db, user_id: str):$/", "language": "Python", "kind": "function", "signature": "(db, user_id: str)"}, {"_type": "tag", "name": "_get_device_owner", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def _get_device_owner(db, device_id: str) -> Optional[str]:$/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "function", "signature": "(db, device_id: str)"}, {"_type": "tag", "name": "_get_usage", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def _get_usage(db, device_id: str, metric: Optional[str], start: Optional[datetime], end: Option/", "language": "Python", "typeref": "typename:List[UsagePoint]", "kind": "function", "signature": "(db, device_id: str, metric: Optional[str], start: Optional[datetime], end: Optional[datetime], rollup: Optional[str])"}, {"_type": "tag", "name": "_handle_telemetry_message", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def _handle_telemetry_message(db, payload: dict):$/", "language": "Python", "kind": "function", "signature": "(db, payload: dict)"}, {"_type": "tag", "name": "_init_firestore_if_needed", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def _init_firestore_if_needed() -> Optional[Any]:$/", "language": "Python", "typeref": "typename:Optional[Any]", "kind": "function", "signature": "()"}, {"_type": "tag", "name": "_mqtt_client", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^_mqtt_client = None$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "_mqtt_on_connect", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def _mqtt_on_connect(client, userdata, flags, rc):$/", "language": "Python", "kind": "function", "signature": "(client, userdata, flags, rc)"}, {"_type": "tag", "name": "_mqtt_on_message", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def _mqtt_on_message(client, userdata, msg):$/", "language": "Python", "kind": "function", "signature": "(client, userdata, msg)"}, {"_type": "tag", "name": "_notify_if_premium", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def _notify_if_premium(db, device_owner_id: str, subject: str, body: str):$/", "language": "Python", "kind": "function", "signature": "(db, device_owner_id: str, subject: str, body: str)"}, {"_type": "tag", "name": "_rollup_range", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def _rollup_range(db, device_id: str, metric: Optional[str], start: datetime, end: datetime, gra/", "language": "Python", "typeref": "typename:List[UsagePoint]", "kind": "function", "signature": "(db, device_id: str, metric: Optional[str], start: datetime, end: datetime, granularity: str)"}, {"_type": "tag", "name": "_send_email", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def _send_email(to_email: str, subject: str, body: str) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(to_email: str, subject: str, body: str)"}, {"_type": "tag", "name": "_set_user_plan", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def _set_user_plan(db, user_id: str, plan: str):$/", "language": "Python", "kind": "function", "signature": "(db, user_id: str, plan: str)"}, {"_type": "tag", "name": "_start_mqtt", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def _start_mqtt():$/", "language": "Python", "kind": "function", "signature": "()"}, {"_type": "tag", "name": "_store_alert", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def _store_alert(db, alert: Dict[str, Any]):$/", "language": "Python", "kind": "function", "signature": "(db, alert: Dict[str, Any])"}, {"_type": "tag", "name": "_user_plan", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def _user_plan(db, user_id: str) -> str:$/", "language": "Python", "typeref": "typename:str", "kind": "function", "signature": "(db, user_id: str)"}, {"_type": "tag", "name": "_verify_razorpay_signature", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def _verify_razorpay_signature(payload_body: bytes, signature: str, secret: str) -> bool:$/", "language": "Python", "typeref": "typename:bool", "kind": "function", "signature": "(payload_body: bytes, signature: str, secret: str)"}, {"_type": "tag", "name": "add_threshold", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def add_threshold(t: Threshold, user=Depends(get_current_user)):$/", "language": "Python", "kind": "function", "signature": "(t: Threshold, user=Depends(get_current_user))"}, {"_type": "tag", "name": "app", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^app = FastAPI($/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "bearer_scheme", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^bearer_scheme = HTTPBearer(auto_error=False)$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "create_device", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def create_device(payload: DeviceCreate, user=Depends(get_current_user)):$/", "language": "Python", "kind": "function", "signature": "(payload: DeviceCreate, user=Depends(get_current_user))"}, {"_type": "tag", "name": "create_jwt", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def create_jwt(user_id: str, email: Optional[str] = None, plan: str = \"free\") -> str:$/", "language": "Python", "typeref": "typename:str", "kind": "function", "signature": "(user_id: str, email: Optional[str] = None, plan: str = \"free\")"}, {"_type": "tag", "name": "credentials", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^    credentials = None$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "decode_jwt", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def decode_jwt(token: str) -> dict:$/", "language": "Python", "typeref": "typename:dict", "kind": "function", "signature": "(token: str)"}, {"_type": "tag", "name": "delete_device", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def delete_device(device_id: str, user=Depends(get_current_user)):$/", "language": "Python", "kind": "function", "signature": "(device_id: str, user=Depends(get_current_user))"}, {"_type": "tag", "name": "delete_threshold", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def delete_threshold(threshold_id: str, user=Depends(get_current_user)):$/", "language": "Python", "kind": "function", "signature": "(threshold_id: str, user=Depends(get_current_user))"}, {"_type": "tag", "name": "description", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^    description: Optional[str] = Field(None, description=\"Description\")$/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "variable", "scope": "DeviceCreate", "scopeKind": "class"}, {"_type": "tag", "name": "description", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^    description: Optional[str] = Field(None, description=\"Description\")$/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "variable", "scope": "DeviceUpdate", "scopeKind": "class"}, {"_type": "tag", "name": "description", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^    description: Optional[str] = None$/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "variable", "scope": "DeviceOut", "scopeKind": "class"}, {"_type": "tag", "name": "device_id", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^    device_id: str = Field(..., description=\"Target device id\")$/", "language": "Python", "typeref": "typename:str", "kind": "variable", "scope": "Threshold", "scopeKind": "class"}, {"_type": "tag", "name": "email", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^    email: EmailStr = Field(..., description=\"User email\")$/", "language": "Python", "typeref": "typename:EmailStr", "kind": "variable", "scope": "AuthRequest", "scopeKind": "class"}, {"_type": "tag", "name": "enabled", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^    enabled: bool = Field(default=True, description=\"Enable\\/disable\")$/", "language": "Python", "typeref": "typename:bool", "kind": "variable", "scope": "Threshold", "scopeKind": "class"}, {"_type": "tag", "name": "end", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^    end: Optional[datetime] = None$/", "language": "Python", "typeref": "typename:Optional[datetime]", "kind": "variable", "scope": "UsageQuery", "scopeKind": "class"}, {"_type": "tag", "name": "firebase_admin", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^    firebase_admin = None$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "firestore", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^    firestore = None$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "floor_day", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^    def floor_day(dt: datetime) -> datetime:$/", "file": true, "language": "Python", "typeref": "typename:datetime", "kind": "function", "signature": "(dt: datetime)", "scope": "_rollup_range", "scopeKind": "function"}, {"_type": "tag", "name": "floor_hour", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^    def floor_hour(dt: datetime) -> datetime:$/", "file": true, "language": "Python", "typeref": "typename:datetime", "kind": "function", "signature": "(dt: datetime)", "scope": "_rollup_range", "scopeKind": "function"}, {"_type": "tag", "name": "get_alerts", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def get_alerts(device_id: str, user=Depends(get_current_user)):$/", "language": "Python", "kind": "function", "signature": "(device_id: str, user=Depends(get_current_user))"}, {"_type": "tag", "name": "get_current_user", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^async def get_current_user(credentials: Optional[HTTPAuthorizationCredentials] = Depends(bearer_/", "language": "Python", "typeref": "typename:dict", "kind": "function", "signature": "(credentials: Optional[HTTPAuthorizationCredentials] = Depends(bearer_scheme))"}, {"_type": "tag", "name": "get_device", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def get_device(device_id: str, user=Depends(get_current_user)):$/", "language": "Python", "kind": "function", "signature": "(device_id: str, user=Depends(get_current_user))"}, {"_type": "tag", "name": "health_check", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def health_check():$/", "language": "Python", "kind": "function", "signature": "()"}, {"_type": "tag", "name": "id", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^    id: Optional[str] = None$/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "variable", "scope": "Threshold", "scopeKind": "class"}, {"_type": "tag", "name": "ingest_http", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def ingest_http(payload: TelemetryIngest, user=Depends(get_current_user)):$/", "language": "Python", "kind": "function", "signature": "(payload: TelemetryIngest, user=Depends(get_current_user))"}, {"_type": "tag", "name": "jwt", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^    jwt = None$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "list_devices", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def list_devices(user=Depends(get_current_user)):$/", "language": "Python", "kind": "function", "signature": "(user=Depends(get_current_user))"}, {"_type": "tag", "name": "list_thresholds", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def list_thresholds(user=Depends(get_current_user)):$/", "language": "Python", "kind": "function", "signature": "(user=Depends(get_current_user))"}, {"_type": "tag", "name": "logger", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^logger = logging.getLogger(\"iot-backend\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "login", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^def login(auth: AuthRequest):$/", "language": "Python", "kind": "function", "signature": "(auth: AuthRequest)"}, {"_type": "tag", "name": "metadata", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^    metadata: Dict[str, Any] = {}$/", "language": "Python", "typeref": "typename:Dict[str, Any]", "kind": "variable", "scope": "DeviceOut", "scopeKind": "class"}, {"_type": "tag", "name": "metadata", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^    metadata: Optional[Dict[str, Any]] = Field(None, description=\"Metadata\")$/", "language": "Python", "typeref": "typename:Optional[Dict[str, Any]]", "kind": "variable", "scope": "DeviceUpdate", "scopeKind": "class"}, {"_type": "tag", "name": "metadata", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^    metadata: Optional[Dict[str, Any]] = Field(default_factory=dict, description=\"Additional met/", "language": "Python", "typeref": "typename:Optional[Dict[str, Any]]", "kind": "variable", "scope": "DeviceCreate", "scopeKind": "class"}, {"_type": "tag", "name": "metric", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^    metric: Optional[str] = None$/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "variable", "scope": "UsageQuery", "scopeKind": "class"}, {"_type": "tag", "name": "mqtt", "path": "/home/kavia/workspace/code-generation/iot-device-management-platform-72343-72373/fastapi_backend/src/api/main.py", "pattern": "/^    import paho.mqtt.client as mqtt$/", "language": "Python", "kind": "namespace", "nameref": "module:paho.mqtt.client"}], "hash": "82915bdab0953b0b98bbfdef9c6ae010", "format-version": 4, "code-base-name": "fastapi_backend", "filename": "fastapi_backend/src/api/main.py", "fields": [{"name": "COL_ALERTS = \"alerts\"", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "COL_DEVICES = \"devices\"", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "COL_PAYMENTS = \"payments\"", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "COL_ROLLUPS = \"rollups\"", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "COL_TELEMETRY = \"telemetry\"", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "COL_THRESHOLDS = \"thresholds\"", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "COL_USER_PLANS = \"user_plans\"", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "EMAIL_FROM = os.getenv(\"EMAIL_FROM\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "FIREBASE_CRED_BASE64 = os.getenv(\"FIREBASE_CRED_BASE64\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "FIREBASE_CRED_JSON = os.getenv(\"FIREBASE_CRED_JSON\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "JWT_ALG = os.getenv(\"JWT_ALG\", \"HS256\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "JWT_EXP_MIN = int(os.getenv(\"JWT_EXP_MIN\", \"60\"))", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "JWT_SECRET = os.getenv(\"JWT_SECRET\", \"dev-secret-change-me\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "MQTT_BROKER_HOST = os.getenv(\"MQTT_BROKER_HOST\", \"broker.hivemq.com\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "MQTT_BROKER_PORT = int(os.getenv(\"MQTT_BROKER_PORT\", \"1883\"))", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "MQTT_PASSWORD = os.getenv(\"MQTT_PASSWORD\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "MQTT_TOPIC = os.getenv(\"MQTT_TOPIC\", \"iot\\/demo\\/telemetry\\/#\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "MQTT_USERNAME = os.getenv(\"MQTT_USERNAME\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "PLAN_FREE_EMAIL_NOTIF = os.getenv(\"PLAN_FREE_EMAIL_NOTIF\", \"false\").lower() == \"true\"", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "PLAN_FREE_MAX_DEVICES = int(os.getenv(\"PLAN_FREE_MAX_DEVICES\", \"2\"))", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "RAZORPAY_KEY_ID = os.getenv(\"RAZORPAY_KEY_ID\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "RAZORPAY_KEY_SECRET = os.getenv(\"RAZORPAY_KEY_SECRET\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "ROLLUP_CRON_DISABLED = os.getenv(\"ROLLUP_CRON_DISABLED\", \"false\").lower() == \"true\"", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "SITE_URL = os.getenv(\"SITE_URL\", \"http:\\/\\/localhost:8000\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "SMTP_HOST = os.getenv(\"SMTP_HOST\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "SMTP_PASS = os.getenv(\"SMTP_PASS\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "SMTP_PORT = int(os.getenv(\"SMTP_PORT\", \"587\")) if os.getenv(\"SMTP_PORT\") else None", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "SMTP_USER = os.getenv(\"SMTP_USER\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "STRIPE_API_KEY = os.getenv(\"STRIPE_API_KEY\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "STRIPE_WEBHOOK_SECRET = os.getenv(\"STRIPE_WEBHOOK_SECRET\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "_db = None", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "_mqtt_client = None", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "app = FastAPI(", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "bearer_scheme = HTTPBearer(auto_error=False)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "credentials = None", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "Optional[str] description", "scope": "DeviceCreate", "scopeKind": "class", "description": "unavailable"}, {"name": "str device_id", "scope": "Threshold", "scopeKind": "class", "description": "unavailable"}, {"name": "EmailStr email", "scope": "AuthRequest", "scopeKind": "class", "description": "unavailable"}, {"name": "bool enabled", "scope": "Threshold", "scopeKind": "class", "description": "unavailable"}, {"name": "Optional[datetime] end", "scope": "UsageQuery", "scopeKind": "class", "description": "unavailable"}, {"name": "firebase_admin = None", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "firestore = None", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "Optional[str] id", "scope": "Threshold", "scopeKind": "class", "description": "unavailable"}, {"name": "jwt = None", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "logger = logging.getLogger(\"iot-backend\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "Dict[str, Any] metadata", "scope": "DeviceOut", "scopeKind": "class", "description": "unavailable"}, {"name": "Optional[Dict[str, Any]] metadata", "scope": "DeviceUpdate", "scopeKind": "class", "description": "unavailable"}, {"name": "Optional[str] metric", "scope": "UsageQuery", "scopeKind": "class", "description": "unavailable"}]}